<!-- Statistics -->
<div id='blocksStats' class="row">

    <!-- Total Blocks Mined -->
    <div class="col-sm-6 hidden-xs col-md-3">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-cubes"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="poolBlocksTotal">Pool Total Blocks </span></div>
                <div class="value"><span id="blocksTotal">N/A</span> <span class="smallText">(<span id="lastBlockFound">Never</span>)</span></div>
            </div>
        </div>
    </div>


 <!-- Average Luck -->
    <div class="col-md-3 hidden-sm hidden-xs">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="poolAverageLuck">Pool Average Luck</span></div>
                <div class="value"><span id="averageLuck">N/A</span></div>
            </div>
        </div>
    </div>

     <!-- Current Effort -->
    <div class="col-md-3 col-sm-6 col-xs-12">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="poolCurrentEffort">Pool Current Effort</span></div>
                <div class="value"><span id="currentEffort">N/A</span></div>
            </div>
        </div>
    </div>



     <!-- Current Effort -->
    <div class="col-md-3 hidden-sm hidden-xs">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-hashtag"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="poolTotalHashes">Pool Hashes</span></div>
                <div class="value"><span id="totalHashes">N/A</span></div>
            </div>
        </div>
    </div>


    


        <!-- Total Blocks Mined -->
    <div class="col-sm-6 hidden-xs col-md-3">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-cubes"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="soloBlocksTotal">Solo Total Blocks</span></div>
                <div class="value"><span id="soloBlocksTotal">N/A</span> <span class="smallText">(<span id="soloLastBlockFound">Never</span>)</span></div>
            </div>
        </div>
    </div>



    <!-- Average Luck -->
    <div class="col-md-3 hidden-sm hidden-xs">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="soloAverageLuck">Solo Average Luck</span></div>
                <div class="value"><span id="soloAverageLuck">N/A</span></div>
            </div>
        </div>
    </div>


     <!-- Current Effort -->
    <div class="col-md-3 col-sm-6 col-xs-12">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="soloCurrentEffort">Solo Current Effort</span></div>
                <div class="value"><span id="soloCurrentEffort">N/A</span></div>
            </div>
        </div>
    </div>

         <!-- Current Effort -->
    <div class="col-md-3 hidden-sm hidden-xs">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-hashtag"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="soloTotalHashes">Solo Hashes</span></div>
                <div class="value"><span id="soloTotalHashes">N/A</span></div>
            </div>
        </div>
    </div>




    <div class="col-sm-6 hidden-xs col-md-3">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-cubes"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="propsBlocksTotal">Props Total Blocks</span></div>
                <div class="value"><span id="propsBlocksTotal">N/A</span> <span class="smallText">(<span id="propsLastBlockFound">Never</span>)</span></div>
            </div>
        </div>
    </div>    



    <!-- Average Luck -->
    <div class="col-md-3 hidden-sm hidden-xs">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="propsAverageLuck">Props Average Luck</span></div>
                <div class="value"><span id="propsAverageLuck">N/A</span></div>
            </div>
        </div>
    </div>
    




     <!-- Current Effort -->
    <div class="col-md-3 col-sm-6 col-xs-12">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="propsCurrentEffort">Props Current Effort</span></div>
                <div class="value"><span id="propsCurrentEffort">N/A</span></div>
            </div>
        </div>
    </div>


         <!-- Current Effort -->
    <div class="col-md-3 hidden-sm hidden-xs">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-hashtag"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="propsTotalHashes">Props Hashes</span></div>
                <div class="value"><span id="propsTotalHashes">N/A</span></div>
            </div>
        </div>
    </div>
    
    <!-- Avg Block -->
    <div class="col-md-3 hidden-xs hidden-sm">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="averageBlockDay">Avg Block Per Day</span></div>
                <div class="value"><span id="averageBlockDay">N/A</span></div>
            </div>
        </div>
    </div>
    
    <!-- Average Income -->
    <div class="col-md-3 hidden-xs hidden-sm">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-chart-line"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="averageIncomeDay">Avg Reward Per Day</span></div>
                <div class="value"><span id="averageIncomeDay">N/A</span></div>
            </div>
        </div>
    </div>


    <!-- Maturity Depth Requirement -->
    <div class="col-md-3 hidden-xs hidden-sm">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-unlock-alt"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="blocksMaturityCount">Maturity</span></div>
                <div class="value"><span id="blocksMaturityCount">N/A</span></div>
            </div>
        </div>
    </div>

    <div class="col-md-3 hidden-xs hidden-sm">
        <div class="infoBox hoverExpandEffect">
            <div class="icon">
                <span class="fa fa-trophy"></span>
            </div>
            <div class="content">
                <div class="text"><span tkey="unlockReward">Unlock Reward</span></div>
                <div class="value"><span id="unlockReward">N/A</span></div>
            </div>
        </div>
    </div>

</div>
<div id="blocksChart" class="card padding-15 padding-t-5 padding-b-5">
    <h4 id="blocksChartTitle">Blocks found</h4>
    <div class="chart" style="height:200px;">
        <canvas id="blocksChartObj"></canvas>
        <a class="chart-style"></a>
    </div>
</div>  

<!-- Report -->
<div class='row'>
	<div class='col-sm-12'>
		<div class="card push-up-10">
		    <div id="blocksReport" class="table-responsive">
		        <table class="table table-hover table-striped">
		            <thead>
		            <tr>
				        <th class="text-center"><span tkey="height">Height</span></th>
		                <th class="text-center"><span tkey="timeFound">Time Found</span></th>
		                <th class="text-center"><span tkey="reward">Reward</span></th>
		                <th class="text-center"><span tkey="difficulty">Difficulty</span></th>
		                <th class="text-center"><span tkey="blockHash">Block Hash</span></th>
		                <th class="text-center"><span tkey="effort">Effort</span></th>
		                <th class="text-center" title="How many more blocks network must mine before this block is matured"><span tkey="status">Status</span></th>
		                <th class="text-center">Unblocker</th>
                        <th class="text-center"><span tkey="donations">Donations</span></th>
                        <th class="text-center"><span tkey="hashes">Hashes</span></th>
                        <th class="text-center">Share Type</th>
		            </tr>
		            </thead>
		            <tbody id="blocksReport_rows">
		            </tbody>
		        </table>
		    </div>
		</div>
		
		<p class="text-center push-up-10">
		    <button type="button" class="btn btn-default" id="loadMoreBlocks"><span tkey="loadMore">Load More</span></button>
		</p>
	</div>
	
</div>


<!-- Javascript -->
<script>
// Hide blocks chart on load
// $('#blocksChart').hide();

// Load more blocks button
var xhrGetBlocks;

// Update current page
currentPage = {
    destroy: function(){
        if (xhrGetBlocks) xhrGetBlocks.abort();
        $('#loadMoreBlocks').off('click');
    },
    update: function(){
    	updateText('currentEffort', (lastStats.pool.stats.roundShares / lastStats.network.difficulty * 100).toFixed(1) + '%');
        updateText('blocksTotal', lastStats.pool.stats.blocksFound.toString());
        if (lastStats.pool.stats.lastBlockFound) {
            var d = new Date(parseInt(lastStats.pool.stats.lastBlockFound)).toISOString();
            $('#lastBlockFound').timeago('update', d);
        }
        else {
            $('#lastBlockFound').removeAttr('title').data('ts', '').update('Never');
        }
        updateText('blocksMaturityCount', lastStats.config.depth.toString());

        $('#averageLuck').html(formatLuck(lastStats.pool.stats.totalDiff, lastStats.pool.stats.totalShares));

        $('#soloAverageLuck').html(formatLuck(lastStats.pool.stats.totalDiff_solo, lastStats.pool.stats.totalShares_solo));

        updateText('soloCurrentEffort', (lastStats.pool.stats.roundSharessolo / lastStats.network.difficulty * 100).toFixed(1) + '%');
        updateText('soloBlocksTotal', lastStats.pool.stats.blocksFound_solo || 0);
        if (lastStats.pool.stats.lastBlockFound_solo) {
            var d = new Date(parseInt(lastStats.pool.stats.lastBlockFound_solo)).toISOString();
            $('#soloLastBlockFound').timeago('update', d);
        }

        $('#propsAverageLuck').html(formatLuck(lastStats.pool.stats.totalDiff_props, lastStats.pool.stats.totalShares_props));

        updateText('propsCurrentEffort', (lastStats.pool.stats.roundSharesprops / lastStats.network.difficulty * 100).toFixed(1) + '%');
        updateText('propsBlocksTotal', lastStats.pool.stats.blocksFound_props || 0);
        if (lastStats.pool.stats.lastBlockFound_props) {
            var d = new Date(parseInt(lastStats.pool.stats.lastBlockFound_props)).toISOString();
            $('#propsLastBlockFound').timeago('update', d);
        }

        updateText('totalHashes', formatDifficulty(lastStats.pool.stats.totalShares || 0));
        updateText('soloTotalHashes', formatDifficulty(lastStats.pool.stats.totalShares_solo || 0));
        updateText('propsTotalHashes', formatDifficulty(lastStats.pool.stats.totalShares_props || 0));



        if (lastStats.charts.blocks) {
            generateChart(lastStats.charts.blocks);
        }


        renderBlocks(lastStats.pool.blocks);
        $('#loadMoreBlocks').on('click',function(){
            if (xhrGetBlocks) xhrGetBlocks.abort();
            xhrGetBlocks = $.ajax({
                url: window.config.api + '/get_blocks',
                data: {
                    height: $('#blocksReport_rows').children().last().data('height')
                },
                dataType: 'json',
                cache: 'false',
                success: function(data){
                    renderBlocks(data);
                }
            });
        });
    }
};



// Chart
var displayedChart = false;
function generateChart(data) {
    if (displayedChart || !data || data === "undefined") return ;

    var chartDays = lastStats.config.blocksChartDays || null;
    var title = getTranslation('poolBlocks') ? getTranslation('poolBlocks') : 'Blocks found';
    if (chartDays) {
        if (chartDays === 1) title = getTranslation('blocksFoundLast24') ? getTranslation('blocksFoundLast24') : 'Blocks found in the last 24 hours';
        else title = getTranslation('blocksFoundLastDays') ? getTranslation('blocksFoundLastDays') : 'Blocks found in the last {DAYS} days';
        title = title.replace('{DAYS}', chartDays);
    }
    updateText('blocksChartTitle', title);

    var labels = [];
    var values = [];
	var avgDay = 0;

    for (var key in data) {
        var label = key;
        if (chartDays && chartDays === 1) {
            var keyParts = key.split(' ');
            label = keyParts[1].replace(':00', '');
        }
        labels.push(label);
        var value = data[key];
        values.push(value);
        avgDay+=value;
    }
    var startDay = new Date("08/01/2020"); 
    var date2 = Date.now()
    var Difference_In_Days = (date2 - startDay.getTime()) / (1000 * 3600 * 24);
    if(Difference_In_Days > lastStats.config.blocksChartDays) {
        Difference_In_Days = lastStats.config.blocksChartDays
    }
    avgDay = Math.round(avgDay / Difference_In_Days);
	updateText('averageBlockDay',avgDay);
    var $chart = $('#blocksChartObj');
    var bgcolor = null, bordercolor = null, borderwidth = null;
    var colorelem = $chart.siblings('a.chart-style');
    if (colorelem.length == 1) {
        bgcolor = colorelem.css('background-color');
        bordercolor = colorelem.css('border-left-color');
        borderwidth = parseFloat(colorelem.css('width'));
    }
    if (bgcolor === null) bgcolor = 'rgba(3, 169, 244, .4)';
    if (bordercolor === null) bordercolor = '#03a9f4';
    if (borderwidth === null || isNaN(borderwidth)) borderwidth = 1;

    var chart = new Chart(document.getElementById('blocksChartObj'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Blocks',
                data: values,
                fill: false,
                backgroundColor: bgcolor,
                borderColor: bordercolor,
                borderWidth: borderwidth
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: false },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        userCallback: function(label, index, labels) {
                            if (Math.floor(label) === label) return label;
                        }
                    }
                }],
            },
            layout: {
                padding: { top: 0, left: 0, right: 0, bottom: 0 }
            }
        }
    });
    $chart.show();
    displayedChart = true;
}

// Parse block data
function parseBlock(height, serializedBlock){
	if(!serializedBlock) {
		return;
	}
    var parts = serializedBlock.split(':');
    var properties = [
		'height',
		'hash',
		'timestamp',
		'difficulty',
		'shares',
		'donations',
		'reward',
		'miner',
		'poolType',
		'orphaned',
		'unlocked'
   ];

	var block = {};
	for(var i =0;i<properties.length;i++) {
	   var property = properties[i];
       switch(property) {
            case 'unlocked':
            block[property] = (parts[i] === true || parts[i] === 'true');
            break;
            case 'orphaned':
            case 'height':
            case 'timestamp':
            case 'difficulty':
            case 'shares':
            case 'donations':
            case 'reward':
            case 'orphaned':
            block[property] = parseInt(parts[i])
            break;
            default:
            block[property] = parts[i]
            break;
        }
	}
    var toGo = lastStats.config.depth - (lastStats.network.height - block.height) + 1;
    if(toGo > 1){
        block.maturity = toGo + ' to go';
    } else if(toGo == 1){
        block.maturity = "<i class='fa fa-spinner fa-spin'></i>";
    } 
    else {
        block.maturity = "<i class='fa fa-unlock-alt'></i>";
    }

    switch (block.orphaned){
        case '0':
            block.status = 'unlocked';
            block.maturity = "<i class='fa fa-unlock-alt'></i>";
            break;
       case '1':
            block.status = 'orphaned';
            block.maturity = "<i class='fa fa-times'></i>";
            break;
        default:
            block.status = 'pending';
            break;
    }
    if(typeof(block.miner) === 'undefined'){
	   block.miner= "xxxxxxx....xxxxxx";
    }

    block.donated = getReadableCoins(block.reward * (block.donations / block.shares));
    return block;
}

// Get block row element
function getBlockRowElement(block, jsonString){        
    function formatBlockLink(hash){
        return '<a target="_blank" href="' + getBlockchainUrl(hash) + '">' + hash.slice(0,7) + '...</a>';
    }

    var blockStatusClasses = {
        'pending': 'pending',
        'unlocked': 'unlocked',
        'orphaned': 'orphaned'
    };
    
    var row = document.createElement('tr');
    row.setAttribute('data-json', jsonString);
    row.setAttribute('data-height', block.height);
    row.setAttribute('id', 'blockRow' + block.height);
    row.setAttribute('title', block.status);
    row.className = blockStatusClasses[block.status];
                
    var reward = "";    
    if(block.reward === false){
        reward = "Waiting...";
    }
    else{
        reward = getReadableCoins(block.reward);
    }
    
    var columns =
    	'<td class="text-center" class="col1">' + block.height + '</td>' +
        '<td class="text-center" class="col2">' + formatDate(block.timestamp) + '</td>' +
        '<td class="text-center" class="col3">' + reward + '</td>' +
        '<td class="text-center" class="col4">' + block.difficulty + '</td>' +
        '<td class="text-center" class="col5">' + formatBlockLink(block.hash) + '</td>' +
        '<td class="text-center" class="col6" title="' + block.shares + ' shares submitted">' + formatLuck(block.difficulty, block.shares) + '</td>' +
        '<td class="text-center" class="col7">' + block.maturity + '</td>'+
        '<td class="text-center" class="col1">' + block.miner + '</td>' +
        '<td class="text-center" class="col1">' + block.donated + '</td>' +
        '<td class="text-center" class="col1">' + block.shares + '</td>' +
        '<td class="text-center" class="col1">' + block.poolType + '</td>';

    row.innerHTML = columns;
    
    return row;
}

const summaries = [];
// Render blocks

function renderBlocks(blocksResults){
	const $blocksRows = $('#blocksReport_rows');
	var blockElementSets = {};
    for (var i = 0; i < blocksResults.length; i++){
    	
        var block = parseBlock(blocksResults[i], blocksResults[i]);
				 if(block.hash === "") continue;
	var dIndex = formatDate(block.timestamp).split(" ")[0];
        var blockJson = JSON.stringify(block);
    	if(!blockElementSets[dIndex]){
    		blockElementSets[dIndex] = {
    			incomes:0,
			donations:0,
    			elements:[],
    			count:0
    		};
    	}
    	
    	if(block.orphaned == 0){
        	blockElementSets[dIndex].incomes+=parseFloat(block.reward);
        	blockElementSets[dIndex].donations+=parseFloat(block.reward * block.donations / block.shares);
        }
        
        var existingRow = document.getElementById('blockRow' + block.height);
        if (existingRow && existingRow.getAttribute('data-json') !== blockJson){
            $(existingRow).replaceWith(getBlockRowElement(block, blockJson));
        } else if (!existingRow){
            var blockElement = getBlockRowElement(block, blockJson);

            var inserted = false;
            var rows = $blocksRows.children().get();
            for (var f = 0; f < rows.length; f++) {
                var bHeight = parseInt(rows[f].getAttribute('data-height'));
                if (bHeight < block.height){
                    inserted = true;
                    $(rows[f]).before(blockElement);
                    break;
                }
            }
            if (!inserted){
        		blockElementSets[dIndex].elements.push(blockElement);
            }
        }
        blockElementSets[dIndex].count++;
    }
    
    const summaryTR = "<tr style='font-weight:900;text-align:center;background:#e9dff1;' id='sum%ID%'>%TD%</tr>";
	const summaryTD = "<td colspan='11' style='background:#e9dff1 !important;'>%DATE% we have mined %BLOCK% block(s) total reward of %REWARD% XLA and total donations %DONATION%</td>";
	var incomes = [];
	
    for(var pastDae in blockElementSets){
    	const blockElementSet = blockElementSets[pastDae];
    	const income = blockElementSet.incomes;
    	const element = blockElementSet.elements;
    	var dated = "On "+pastDae;
    	if((new Date()).toLocaleDateString() === pastDae){
    		dated = "Today";
        }
        var sumID = pastDae.replace(new RegExp("/","g"),"_");
        var sumRow = document.getElementById("sum"+sumID);
        var td = summaryTD
			.replace("%REWARD%", getReadableCoins(income, 2, true))
			.replace("%BLOCK%",blockElementSet.count)
			.replace("%DATE%",dated)
			.replace("%DONATION%",getReadableCoins(blockElementSet.donations));
		
		if(sumRow){
			sumRow.innerHTML = td;
		}else{
    		$blocksRows.append(summaryTR.replace("%TD%",td).replace("%ID%",sumID));
    		
    		for(iii in element){
    			$blocksRows.append(element[iii]);
    		}
		}
		incomes.push(income);
		
    }
   
    var incomeValue = 0;
    var incomeCount = 0;
    for(var dae in incomes){
    	var v = incomes[dae];
    	incomeCount++;
    	incomeValue+=v;
    }
	
    updateText("averageIncomeDay",getReadableCoins(incomeValue/incomeCount, 2, false));
    updateText("unlockReward",lastStats.config.unlockBlockReward +"%");
}

</script>
